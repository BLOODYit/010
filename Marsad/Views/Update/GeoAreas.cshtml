
@{
    ViewBag.Title = "تحديث العناصر والقيم";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="container">
    <div class="row">
        <div class="col-xs-12">
            <h1>تحديث العناصر والقيم - @ViewBag.TypeName</h1>
            <hr />
            <form action="@Url.Action("GeoAreas")" method="get">
                <div class="form-group" id="IndicatorIDDiv">
                    <label class="control-label col-sm-2 col-xs-12">@ViewBag.TypeName</label>
                    <div class="col-sm-10 col-xs-12">
                        @Html.DropDownList("GeoAreaID", null, htmlAttributes: new { @class = "form-control", @id = "GeoAreaID" })
                    </div>
                </div>

                <div class="form-group">
                    @Html.Label("الحزمة", null, htmlAttributes: new { @class = "control-label col-sm-2 col-xs-12" })
                    <div class="col-sm-10 col-xs-12">
                        @Html.DropDownList("BundleID", null, htmlAttributes: new { @class = "form-control", @id = "BundleID" })
                    </div>
                </div>

                <div class="form-group">
                    <label class="control-label col-sm-2 col-xs-12">المؤشر</label>
                    <div class="col-sm-10 col-xs-12">
                        <input type="text" id="elementNames" class="form-control" placeholder="تصفية المؤشر بالعنصر" />
                        <input type="text" id="IndicatorName" class="form-control" placeholder="البحث عن المؤشر" />
                        <select id="IndicatorID" name="IndicatorID" class="form-control" required>
                            <option value="">-- إختر المؤشر --</option>
                        </select>
                    </div>
                </div>
            </form>

            <div id="indicator"></div>
        </div>
    </div>
</div>

@section  scripts{
    <script type="text/javascript">
         function getIndicator() {
                $('#indicator').html('');
                var indicatorId = $('#IndicatorID').val();
                var geoAreaId = $('#GeoAreaID').val();
                if (indicatorId > 0 && geoAreaId > 0) {
                    $.get("@Url.Action("GetIndicatorEquations","Update")/?indicatorId="+indicatorId+"&geoAreaId="+geoAreaId, function (data, status) {
                        $('#indicator').html(data);
                    });
                }
        }
        var indIds = [];

        $(function () {
            $('#BundleID').change(function (e) {
                var id = $(this).val();
                $('#IndicatorID option').remove();

                $('#IndicatorID').append("<option value=''>-- إختر المؤشر --</option>");
                $.get("@Url.Action("GetIndicatorsWithValues","Bundles")/" + id, function (data,status) {
                    data.data.forEach(function (e, i) {
                        $('#IndicatorID').append("<option value='"+e.ID+"'>"+e.Name+"</option>");
                    });
                });
            });
            $('#BundleID').change();
            $('#IndicatorID,#GeoAreaID').change(function () {
                getIndicator();
            });

            function filterIndicators() {
                $('#IndicatorID').val('');
                var val = $('#IndicatorName').val();
                $('#IndicatorID option').each(function () {
                    var option = $(this);
                    var show = option.text().toLowerCase().indexOf(val.toLowerCase()) >= 0;
                    show = show && (indIds.length === 0 || indIds.includes(option.val() * 1));
                    show = show || option.val() == '';
                    if (show) {
                        option.removeAttr('hidden');
                    }
                    else {
                        option.attr('hidden','hidden');
                    }
                });
            }
            $('#IndicatorName').keyup(function () {
                filterIndicators();
            });
            var elements = [
                @foreach(var d  in ViewBag.Elements.Keys)
                {
                    <text>{ value: '@d', data: @Html.Raw(Json.Encode(ViewBag.Elements[d])) },</text>
                }
            ];

            $('#elementNames').change(function () {
                if ($(this).val() === '') {
                    indIds = [];
                    filterIndicators();
                }
            });

            $('#elementNames').autocomplete({
                lookup: elements,
                onSelect: function (suggestion) {
                    indIds = suggestion.data;
                    filterIndicators();
                },
            });
        });
    </script>
}