@using Marsad.Models.Controls
@model IEnumerable<Marsad.Models.Bundle>
@{
    ViewBag.Title = "تقرير حزم المؤشرات الحضرية";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <h2>تقرير حزم المؤشرات الحضرية</h2>
        </div>
    </div>
    <div class="row">
        <form action="@Url.Action("Bundles","Reports")" method="get">
            <div class="col-sm-8">
                @Html.Partial("~/Views/Shared/Controls/_MultiSelect.cshtml", new MultiSelectModel() { ID = "bundles", Data = ViewBag.Bundles, Title = "الحزم", Name = "bundleIds", Selected = ViewBag.bundleIds })
            </div>
            <div class="col-sm-12">
                <button class="btn btn-primary" type="submit">عرض التقرير </button>
                <button class="btn btn-success" type="button" id="export">تصدير</button>
            </div>
        </form>
    </div>
    <div class="row">
        <div class="col-xs-12" id="html-report">
            <table class="table table-striped jambo_table" id="html-table">
                <thead>
                    <tr class="headings">
                        <th class="column-title">كود المؤشر</th>
                        <th class="column-title">أسم المؤشر</th>                        
                        <th class="column-title">نوع المؤشر</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        ushort i = 0;
                    }
                    @foreach (var bundle in Model)
                    {
                        <tr class="@(i++%2==0?"even_pointer":"odd_pointer")">
                            <th colspan="3">@bundle.Name</th>
                        </tr>
                        if (bundle.Indicators == null || bundle.Indicators.Count == 0)
                        {
                            <tr class="@(i++%2==0?"even_pointer":"odd_pointer")">
                                <td colspan="3">لا يوجد مؤشرات لهذه الحزمة</td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <th>كود المؤشر</th>
                                <th>إسم المؤشر</th>
                                <th>نوع المؤشر</th>
                            </tr>
                            foreach (var indicator in bundle.Indicators)
                            {
                                <tr>
                                    <td>@indicator.Code</td>
                                    <td>@indicator.Name</td>
                                    <td>@(indicator.HasParent ? "فرعي" : "رئيسي")</td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>            
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        $('#export').click(function () {
             var rtlTable = $('#html-table').clone();
                rtlTable.find('tr').each(function () {
                    var tds = $(this).children('td,th').get().reverse();
                    $(this).append(tds);
                });             
            var pdf = new jsPDF();
            pdf.setFont('Amiri');
            pdf.text('تقرير حزم المؤشرات الحضرية', (pdf.internal.pageSize.width / 2), 12, 'center');
            pdf.autoTable({ html: rtlTable.get()[0], startY: 20, styles: { textAlign: "right", font: "Amiri" } });            
            pdf.save("reprt.pdf");
        });
    });
</script>